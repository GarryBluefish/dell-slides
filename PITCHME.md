### Spring Data JPA and Hibernate

---

![diagram](https://kroki.io/mermaid/svg/eNptzk0OgjAQBeC9p5glmHABTEhIiyENxh-8wAAjaYIF2-L5bYsaE-zyfW9maugxk2qJS-w13jfg3oTaylZOqCwwQANsVFaPw0B65cJ7PWmpeuBoEcQpX5VKXyplQ1qhpRVzz364QUObwCzJMpHCTaouH4YQCReV3wginO2Y9KRIu51dHDql6_AU6qIq2BW2sL8cDzAb0mYXnCfLkhBB5_8b1efqM7wc_UWBT4zf552yP_oClq9gFA==)

---

### Spring Data JPA

- JPA -> Java Persistence API
- wraps around Hibernate

+++

### Hibernate

- implementation of JPA spec
- full ORM

---

## Spring Data JPA

---

### Setup

- add Spring Data JPA to list of dependencies
- add DB config to application.properties (we can skip this)

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
```

+++

### application.properties Set Up

```
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
spring.datasource.driverClassName=com.microsoft.sqlserver.jdbc.SQLServerDriver
spring.datasource.url=jdbc:sqlserver://localhost;databaseName=employee_demo
spring.datasource.username=mingxiangchan
spring.datasource.password=123123
```

---

### Usage

- define your entities according to JPA spec
- define the entity repository/DAO
- use auto-generated query methods
- add any additional queries you need (optional)

---

### Defining Entities (JPA)

```java
@Entity
public class Department {
  @Id
  @GeneratedValue(strategy=GenerationType.IDENTITY)
  private Long id;
  private String name;

  @Column(name = "name")
  private String name;

  @Column(name = "address")
  private String address;
  
  // ...getters and setters
}
```

+++

### Create Repository Interface

```java
import org.springframework.data.jpa.repository.JpaRepository;

public interface DepartmentRepository extends JpaRepository<Department, Long> {
}
```

+++

### Using Interface in Controller

```java
@RestController
@RequestMapping(path="/")
public class DepartmentController {
  @Autowired
	private DepartmentRepository departmentRepository;
	
	@GetMapping(path="/departments", produces="application/json")
	public List<Department> getDeparments() {
		return departmentRepository.findAll();
	}
}
```

---

### Spring Data JPA - Queries

Autogenerated Queries

```java
// Autogenerated Queries
repository.count()
repository.findAll()
repository.findById()
repository.existsById()
```

+++

Adding Additional Queries

```java
public interface DepartmentRepository extends JpaRepository<Department, Long> {
    Department findByName(String name);
    List<Department> findAllByName(String name);
    
    // Multiple Criteria
    List<Department> findByNameAndNumEmployees(String name, int numEmployees);

    // Complex Example
    // generates SQL LIKE statement that is case insensitive
    List<Department> findByNameContainingIgnoreCase(String name);
}
```

+++

Writing Custom SQL

```java
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("SELECT u FROM User u WHERE u.role = 'student'")
    List<User> findStudents();

    // with variables
    @Query("SELECT u FROM User u WHERE u.name = ?1 AND u.email = ?2")
    List<User> findByNameAndEmail(String name, String email);

    // with named variables
    @Query("SELECT u FROM User u WHERE u.name = :name'")
    List<User> findWithName(@Param("name") String name);
}
```

---

### Query Exercise

```bash
/bookings
/properties
/reviews
/bookings/{id}
/properties/{id}
/reviews/{id}
```

+++

### Query Exercises

```bash
# search by total price more than x
/bookings?minTotalPrice=200

# search by total price less than y
/bookings?maxTotalPrice=200

# search by total price between x and y
/bookings?minTotalPrice=200&maxTotalPrice=300
```

+++

### Custom Query Exercises

```bash
# search by price more than x
/properties?minPrice=200

# search by price less than y
/properties?maxPrice=200

# search by price between x and y
/properties?minPrice=200&maxTotalPrice=300
```
+++

### JOIN Exercises

```bash
# list reviews for property with id
/properties/{id}/reviews

# list properties with tags
/properties?tag=pets_allowed
```



+++

#### Property Show

```
/api/property/{id}
```

```json
{
  "property": {
    "id": int,
    "address": string,
    "price": int
  },
  "goodReviews": {
    "id": int,
    "remark": string,
    "rating": int
  },
  "badReviews": {
    "id": int,
    "remark": string,
    "rating": int
  }
}
```

---

### Spring Data JPA - Updates

```java
User user = userRepository.findById(2);

// Autogenerated Update Methods
userRepository.delete(user)
```

+++

Modify the object and trigger save

```java
// Insert
User user = new User("Jane");
userRepository.save(user);

// Update
User user = userRepository.findById(2);
user.setName("John");
userRepository.save(user);
```
---

#### Handling Associations

---

### One To Manys

+++

#### Parent Side

```java
@Entity
public class User {

   @Id
    @GeneratedValue
    private long id;

    @OneToMany(mappedBy = "user")
    private Set<Booking> bookings;
}
```

+++

#### Child Side

```java
@Entity
public class Booking {

   @Id
    @GeneratedValue
    private long id;

    @OneToOne
    @JoinColumn(name = "user_id")
    private User user;
}
```

---

### Many To Many

```java
@Entity
public class Contact {

  @Id
  @GeneratedValue
  private long id;

  @ManyToMany(cascade=CascadeType.ALL)
  @JoinTable(
    name="contacts_groups", 
    joinColumns={@JoinColumn(referencedColumnName="id")}, 
    inverseJoinColumns={@JoinColumn(referencedColumnName="id")}
  ) 
  private Set<Group> groups;
}
```

---

### Cascade and FetchType

+++

#### Cascade

- automatically saves the object and its associated object
- e.g. using save on the `user` will automatically update his/her `bookings`

```java
@OneToMany(cascade=CascadeType.ALL)
```

[More Info](https://howtodoinjava.com/hibernate/hibernate-jpa-cascade-types/)

+++

#### FetchType

- eager -> automatically query for associated objects
- lazy -> delay querying for associated objects unless used directly

```java
@OneToMany(fetch = FetchType.LAZY)
@OneToMany(fetch = FetchType.EAGER)
```

[More Info](https://howtodoinjava.com/hibernate/lazy-loading-in-hibernate/)]




